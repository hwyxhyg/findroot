<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¯»æ ¹ Â· å½’å¤„</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600&family=Noto+Sans+SC:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1208;
    --paper: #f5efe3;
    --warm: #c8956c;
    --gold: #b8860b;
    --red: #8b2020;
    --shadow: rgba(26,18,8,0.12);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--paper);
    color: var(--ink);
    font-family: 'Noto Sans SC', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      radial-gradient(ellipse at 20% 50%, rgba(200,149,108,0.08) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 20%, rgba(139,32,32,0.05) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  body::after {
    content: '';
    position: fixed;
    left: 0; top: 0; bottom: 0;
    width: 4px;
    background: linear-gradient(to bottom, transparent, var(--red), var(--gold), var(--red), transparent);
    opacity: 0.4;
  }

  header {
    position: relative;
    z-index: 10;
    padding: 1.2rem 2rem;
    border-bottom: 1px solid rgba(184,134,11,0.2);
    display: flex;
    align-items: center;
    gap: 1.5rem;
    background: rgba(245,239,227,0.95);
    backdrop-filter: blur(8px);
  }

  .logo { font-family: 'Noto Serif SC', serif; font-size: 1.6rem; font-weight: 600; color: var(--red); letter-spacing: 0.1em; }
  .logo-sub { font-size: 0.8rem; color: var(--gold); letter-spacing: 0.2em; font-weight: 300; }

  .header-right { margin-left: auto; display: flex; align-items: center; gap: 1rem; }

  .panel-toggle {
    background: rgba(200,149,108,0.1);
    border: 1px solid rgba(200,149,108,0.3);
    border-radius: 4px;
    padding: 0.4rem 0.9rem;
    font-size: 0.78rem;
    color: var(--ink);
    cursor: pointer;
    font-family: 'Noto Sans SC', sans-serif;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .panel-toggle:hover { background: rgba(200,149,108,0.2); }
  .panel-toggle .badge {
    background: var(--red);
    color: white;
    border-radius: 10px;
    padding: 0 5px;
    font-size: 0.65rem;
    display: none;
  }
  .panel-toggle .badge.visible { display: inline; }

  .status-dot { display: flex; align-items: center; gap: 0.4rem; font-size: 0.72rem; color: var(--warm); }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: #5a8a5a; animation: pulse 2s infinite; }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

  /* Layout */
  .app-body {
    flex: 1;
    display: flex;
    position: relative;
    overflow: hidden;
  }

  /* Chat area */
  .chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    max-width: 780px;
    margin: 0 auto;
    width: 100%;
    padding: 1.5rem 2rem 0;
    position: relative;
    z-index: 1;
    transition: max-width 0.3s ease;
  }

  /* Side panel */
  .side-panel {
    width: 0;
    overflow: hidden;
    transition: width 0.3s ease;
    border-left: 1px solid rgba(184,134,11,0.15);
    background: rgba(255,255,255,0.6);
    backdrop-filter: blur(4px);
    position: relative;
    z-index: 5;
    flex-shrink: 0;
  }

  .side-panel.open {
    width: 320px;
  }

  .side-panel-inner {
    width: 320px;
    height: 100%;
    overflow-y: auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
  }

  .panel-section {
    background: white;
    border: 1px solid rgba(184,134,11,0.15);
    border-radius: 6px;
    overflow: hidden;
  }

  .panel-section-header {
    padding: 0.7rem 1rem;
    background: rgba(200,149,108,0.08);
    border-bottom: 1px solid rgba(184,134,11,0.1);
    font-family: 'Noto Serif SC', serif;
    font-size: 0.82rem;
    color: var(--red);
    font-weight: 600;
    letter-spacing: 0.05em;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .panel-section-body {
    padding: 0.8rem 1rem;
    font-size: 0.8rem;
    line-height: 1.7;
    color: var(--ink);
  }

  .info-row {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.4rem;
    align-items: flex-start;
  }

  .info-label {
    color: var(--gold);
    font-weight: 400;
    min-width: 70px;
    flex-shrink: 0;
    font-size: 0.75rem;
    margin-top: 1px;
  }

  .info-value { color: var(--ink); }
  .info-empty { color: rgba(26,18,8,0.3); font-style: italic; }

  /* Todo list */
  .todo-list { display: flex; flex-direction: column; gap: 0.5rem; }

  .todo-item {
    display: flex;
    align-items: flex-start;
    gap: 0.6rem;
    padding: 0.5rem 0.7rem;
    border-radius: 4px;
    border: 1px solid rgba(184,134,11,0.15);
    cursor: pointer;
    transition: all 0.15s;
    font-size: 0.78rem;
    line-height: 1.5;
  }

  .todo-item:hover { background: rgba(200,149,108,0.06); }
  .todo-item.done { opacity: 0.5; }
  .todo-item.done .todo-text { text-decoration: line-through; }

  .todo-check {
    width: 16px;
    height: 16px;
    border: 1.5px solid rgba(184,134,11,0.4);
    border-radius: 3px;
    flex-shrink: 0;
    margin-top: 1px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    font-size: 10px;
    color: white;
  }

  .todo-item.done .todo-check {
    background: var(--gold);
    border-color: var(--gold);
  }

  .empty-panel {
    text-align: center;
    padding: 2rem 1rem;
    color: rgba(26,18,8,0.3);
    font-size: 0.8rem;
    line-height: 1.8;
  }

  /* Welcome */
  .welcome {
    text-align: center;
    padding: 3rem 2rem;
    animation: fadeIn 1s ease;
  }

  .welcome-character {
    font-family: 'Noto Serif SC', serif;
    font-size: 5rem;
    color: var(--red);
    opacity: 0.15;
    line-height: 1;
    margin-bottom: 1.5rem;
    letter-spacing: 0.3em;
  }

  .welcome h1 { font-family: 'Noto Serif SC', serif; font-size: 1.5rem; font-weight: 400; margin-bottom: 0.8rem; }
  .welcome p { font-size: 0.88rem; color: var(--warm); line-height: 1.8; max-width: 400px; margin: 0 auto; font-weight: 300; }

  .welcome-prompts { margin-top: 2rem; display: flex; flex-direction: column; gap: 0.5rem; align-items: center; }

  .prompt-chip {
    background: rgba(200,149,108,0.1);
    border: 1px solid rgba(200,149,108,0.25);
    border-radius: 2px;
    padding: 0.55rem 1.1rem;
    font-size: 0.8rem;
    color: var(--ink);
    cursor: pointer;
    transition: all 0.2s;
    max-width: 380px;
    text-align: center;
  }
  .prompt-chip:hover { background: rgba(200,149,108,0.2); transform: translateX(4px); }

  /* Messages */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 1rem;
    display: none;
    flex-direction: column;
    gap: 1.2rem;
  }
  .messages.visible { display: flex; }

  .message { display: flex; gap: 0.8rem; animation: slideIn 0.3s ease; }
  @keyframes slideIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
  .message.user { flex-direction: row-reverse; }

  .avatar {
    width: 32px; height: 32px;
    border-radius: 2px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Noto Serif SC', serif;
    font-size: 0.8rem;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .avatar.agent { background: var(--red); color: var(--paper); }
  .avatar.user { background: var(--ink); color: var(--paper); opacity: 0.7; }

  .bubble {
    max-width: 75%;
    padding: 0.9rem 1.1rem;
    line-height: 1.8;
    font-size: 0.88rem;
    font-weight: 300;
  }

  .message.agent .bubble {
    background: white;
    border: 1px solid rgba(184,134,11,0.15);
    border-radius: 0 8px 8px 8px;
    box-shadow: 0 2px 12px var(--shadow);
  }

  .message.user .bubble {
    background: var(--ink);
    color: var(--paper);
    border-radius: 8px 0 8px 8px;
    opacity: 0.85;
  }

  .bubble h3 { font-family: 'Noto Serif SC', serif; color: var(--red); margin: 0.8em 0 0.3em; font-size: 0.95rem; }
  .bubble h4 { font-family: 'Noto Serif SC', serif; color: var(--red); margin: 0.6em 0 0.2em; font-size: 0.88rem; }
  .bubble strong { font-weight: 600; color: var(--ink); }
  .bubble hr { border: none; border-top: 1px solid rgba(184,134,11,0.15); margin: 0.8em 0; }

  /* Typing indicator - FIXED */
  .typing {
    display: none;
    gap: 0.8rem;
    align-items: flex-start;
  }
  .typing.visible { display: flex; }

  .typing-dots {
    background: white;
    border: 1px solid rgba(184,134,11,0.15);
    border-radius: 0 8px 8px 8px;
    padding: 0.9rem 1.2rem;
    display: flex;
    gap: 4px;
    align-items: center;
    box-shadow: 0 2px 12px var(--shadow);
  }

  .typing-dots span {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--warm);
    animation: bounce 1.2s infinite;
  }
  .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
  .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes bounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-5px); opacity: 1; }
  }

  /* Input */
  .input-area {
    position: sticky;
    bottom: 0;
    background: linear-gradient(to top, var(--paper) 80%, transparent);
    padding: 1rem 0 1.5rem;
    z-index: 10;
  }

  .input-wrap {
    display: flex;
    border: 1px solid rgba(184,134,11,0.3);
    border-radius: 3px;
    background: white;
    box-shadow: 0 4px 20px var(--shadow);
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .input-wrap:focus-within { border-color: var(--warm); }

  textarea {
    flex: 1;
    border: none; outline: none;
    padding: 0.9rem 1.1rem;
    font-family: 'Noto Sans SC', sans-serif;
    font-size: 0.88rem;
    font-weight: 300;
    color: var(--ink);
    background: transparent;
    resize: none;
    min-height: 48px;
    max-height: 140px;
    line-height: 1.6;
  }
  textarea::placeholder { color: rgba(26,18,8,0.3); }

  .send-btn {
    background: none; border: none;
    border-left: 1px solid rgba(184,134,11,0.2);
    padding: 0 1.1rem;
    cursor: pointer;
    color: var(--warm);
    transition: all 0.2s;
    font-size: 1rem;
    display: flex; align-items: center;
  }
  .send-btn:hover { background: rgba(200,149,108,0.1); color: var(--red); }
  .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }

  .hint { text-align: center; font-size: 0.7rem; color: rgba(26,18,8,0.25); margin-top: 0.5rem; }

  .error-msg {
    background: rgba(139,32,32,0.06);
    border: 1px solid rgba(139,32,32,0.2);
    border-radius: 4px;
    padding: 0.6rem 1rem;
    font-size: 0.8rem;
    color: var(--red);
    text-align: center;
    display: none;
    margin-bottom: 0.5rem;
  }
  .error-msg.visible { display: block; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

  .messages::-webkit-scrollbar { width: 3px; }
  .messages::-webkit-scrollbar-track { background: transparent; }
  .messages::-webkit-scrollbar-thumb { background: rgba(200,149,108,0.3); border-radius: 2px; }
  .side-panel-inner::-webkit-scrollbar { width: 3px; }
  .side-panel-inner::-webkit-scrollbar-track { background: transparent; }
  .side-panel-inner::-webkit-scrollbar-thumb { background: rgba(200,149,108,0.2); border-radius: 2px; }
</style>
</head>
<body>

<header>
  <div class="logo">å¯»æ ¹</div>
  <div class="logo-sub">å½’å¤„ Â· æµ·å¤–åäººå¯»æ ¹å‘å¯¼</div>
  <div class="header-right">
    <button class="panel-toggle" onclick="togglePanel()" id="panelBtn">
      ğŸ“‹ å¯»æ ¹æ¡£æ¡ˆ
      <span class="badge" id="todoBadge">0</span>
    </button>
    <div class="status-dot">
      <span class="dot"></span>
      å‘å¯¼åœ¨çº¿
    </div>
  </div>
</header>

<div class="app-body">
  <div class="chat-area">
    <div class="welcome" id="welcome">
      <div class="welcome-character">æ ¹</div>
      <h1>æ ‘æœ‰æ ¹ï¼Œäººä¸èƒ½å¿˜æœ¬</h1>
      <p>å‘Šè¯‰æˆ‘ä½ æ‰€çŸ¥é“çš„ä¸€åˆ‡â€”â€”å“ªæ€•åªæ˜¯ä¸€ä¸ªæ¨¡ç³Šçš„åœ°åï¼Œæˆ–æ˜¯è€äººç•™ä¸‹çš„åªè¨€ç‰‡è¯­ã€‚</p>
      <div class="welcome-prompts">
        <div class="prompt-chip" onclick="usePrompt(this)">æˆ‘æ˜¯é©¬æ¥è¥¿äºšåäººï¼ŒåªçŸ¥é“ç¥–ç±æ˜¯ç¦å»ºï¼Œæƒ³æ‰¾åˆ°æ›´å…·ä½“çš„åœ°æ–¹</div>
        <div class="prompt-chip" onclick="usePrompt(this)">çˆ·çˆ·è¯´æˆ‘ä»¬æ˜¯å¹¿ä¸œäººï¼Œå®¶é‡Œè¯´å®¢å®¶è¯ï¼Œæƒ³å¸®ä»–å®Œæˆå›ä¹¡çš„å¿ƒæ„¿</div>
        <div class="prompt-chip" onclick="usePrompt(this)">æˆ‘æœ‰ä¸€å¼ è€ç…§ç‰‡å’Œä¸€ä¸ªç¥–å…ˆçš„åå­—ï¼Œä¸çŸ¥é“ä»å“ªé‡Œå¼€å§‹å¯»æ ¹</div>
      </div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="typing" id="typing">
      <div class="avatar agent">å‘</div>
      <div class="typing-dots">
        <span></span><span></span><span></span>
      </div>
    </div>

    <div class="input-area">
      <div class="error-msg" id="error"></div>
      <div class="input-wrap">
        <textarea id="input" placeholder="å‘Šè¯‰æˆ‘ä½ çŸ¥é“çš„å…³äºå®¶æ—çš„ä»»ä½•ä¿¡æ¯â€¦â€¦" rows="1"
          onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">â†‘</button>
      </div>
      <div class="hint">æŒ‰ Enter å‘é€ Â· Shift+Enter æ¢è¡Œ</div>
    </div>
  </div>

  <!-- Side Panel -->
  <div class="side-panel" id="sidePanel">
    <div class="side-panel-inner">

      <div class="panel-section">
        <div class="panel-section-header">ğŸ“‹ å·²æ”¶é›†çš„ä¿¡æ¯</div>
        <div class="panel-section-body" id="infoPanel">
          <div class="empty-panel">å¼€å§‹å¯¹è¯åï¼Œ<br>æˆ‘ä¼šåœ¨è¿™é‡Œæ•´ç†ä½ çš„å®¶æ—ä¿¡æ¯</div>
        </div>
      </div>

      <div class="panel-section">
        <div class="panel-section-header">âœ… ä¸‹ä¸€æ­¥è¡ŒåŠ¨</div>
        <div class="panel-section-body" id="todoPanel">
          <div class="empty-panel">æ ¹æ®å¯»æ ¹è¿›å±•ï¼Œ<br>æˆ‘ä¼šä¸ºä½ ç”Ÿæˆè¡ŒåŠ¨æ¸…å•</div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  const API_URL = '/api/chat';
  let sessionId = 'sess_' + Math.random().toString(36).substr(2, 16);
  let isLoading = false;
  let conversationStarted = false;
  let panelOpen = false;
  let todos = [];
  let familyInfo = {};

  function togglePanel() {
    panelOpen = !panelOpen;
    document.getElementById('sidePanel').classList.toggle('open', panelOpen);
    document.getElementById('panelBtn').textContent = panelOpen ? 'âœ• å…³é—­æ¡£æ¡ˆ' : 'ğŸ“‹ å¯»æ ¹æ¡£æ¡ˆ';
    if (panelOpen) {
      const badge = document.getElementById('todoBadge');
      badge.classList.remove('visible');
    }
  }

  function usePrompt(el) {
    document.getElementById('input').value = el.textContent;
    sendMessage();
  }

  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  }

  function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 140) + 'px';
  }

  function showError(msg) {
    const el = document.getElementById('error');
    el.textContent = msg;
    el.classList.add('visible');
    setTimeout(() => el.classList.remove('visible'), 5000);
  }

  function formatMarkdown(text) {
    return text
      .replace(/### (.+)/g, '<h4>$1</h4>')
      .replace(/## (.+)/g, '<h3>$1</h3>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/---/g, '<hr>')
      .replace(/\n/g, '<br>');
  }

  function addMessage(role, text) {
    if (!conversationStarted) {
      document.getElementById('welcome').style.display = 'none';
      document.getElementById('messages').classList.add('visible');
      conversationStarted = true;
    }
    const messages = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = `message ${role}`;
    div.innerHTML = `
      <div class="avatar ${role}">${role === 'agent' ? 'å‘' : 'æˆ‘'}</div>
      <div class="bubble">${formatMarkdown(text)}</div>
    `;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
    return div;
  }

  // FIXED: separate show/hide for typing
  function showTyping() {
    const typing = document.getElementById('typing');
    typing.classList.add('visible');
    scrollToBottom();
  }

  function hideTyping() {
    const typing = document.getElementById('typing');
    typing.classList.remove('visible');
  }

  function scrollToBottom() {
    const messages = document.getElementById('messages');
    messages.scrollTop = messages.scrollHeight;
  }

  // Extract info and todos from agent response
  function parseAgentResponse(text) {
    // Extract family info
    constå§“æ° = text.match(/\*\*å§“æ°\*\*[ï¼š:]\s*([^\n*]+)/);
    constç¥–ç± = text.match(/\*\*ç¥–ç±åœ°\*\*[ï¼š:]\s*([^\n*]+)/);
    constæ–¹è¨€ = text.match(/\*\*æ–¹è¨€ç±»å‹\*\*[ï¼š:]\s*([^\n*]+)/);
    constè¿ç§» = text.match(/\*\*è¿ç§»æ—¶é—´\*\*[ï¼š:]\s*([^\n*]+)/);
    constäº²å± = text.match(/\*\*å·²çŸ¥äº²å±\*\*[ï¼š:]\s*([^\n*]+)/);
    constç½®ä¿¡åº¦ = text.match(/\*\*ç½®ä¿¡åº¦\*\*[ï¼š:]\s*([^\n*]+)/);
    constç±è´¯ = text.match(/\*\*å¯èƒ½çš„ç±è´¯èŒƒå›´\*\*[ï¼š:]\s*([^\n*]+)/);

    let updated = false;
    if (å§“æ° && !å§“æ°[1].includes('æœªæä¾›')) { familyInfo.å§“æ° = å§“æ°[1].trim(); updated = true; }
    if (ç¥–ç± && !ç¥–ç±[1].includes('æœªæä¾›')) { familyInfo.ç¥–ç±åœ° = ç¥–ç±[1].trim(); updated = true; }
    if (æ–¹è¨€ && !æ–¹è¨€[1].includes('æœªæä¾›')) { familyInfo.æ–¹è¨€ = æ–¹è¨€[1].trim(); updated = true; }
    if (è¿ç§» && !è¿ç§»[1].includes('æœªæä¾›')) { familyInfo.è¿ç§»æ—¶é—´ = è¿ç§»[1].trim(); updated = true; }
    if (äº²å± && !äº²å±[1].includes('æœªæä¾›')) { familyInfo.å·²çŸ¥äº²å± = äº²å±[1].trim(); updated = true; }
    if (ç½®ä¿¡åº¦) { familyInfo.ç½®ä¿¡åº¦ = ç½®ä¿¡åº¦[1].trim(); updated = true; }
    if (ç±è´¯) { familyInfo.ç±è´¯æ¨æ–­ = ç±è´¯[1].trim(); updated = true; }

    // Extract todos from "ä¸‹ä¸€æ­¥å»ºè®®"
    const todoSection = text.match(/ä¸‹ä¸€æ­¥å»ºè®®[^]*?(?=ğŸ‘¥|ğŸ’–|$)/);
    if (todoSection) {
      const items = todoSection[0].match(/\d+\.\s*\*\*(.+?)\*\*[ï¼š:]?\s*([^\n]+)?/g);
      if (items) {
        items.forEach(item => {
          const match = item.match(/\d+\.\s*\*\*(.+?)\*\*/);
          if (match) {
            const todoText = match[1].trim();
            if (!todos.find(t => t.text === todoText)) {
              todos.push({ text: todoText, done: false });
              updated = true;
            }
          }
        });
      }
    }

    if (updated) updatePanel();
  }

  function updatePanel() {
    // Update info panel
    const infoPanel = document.getElementById('infoPanel');
    if (Object.keys(familyInfo).length > 0) {
      const labels = {
        å§“æ°: 'å§“æ°', ç¥–ç±åœ°: 'ç¥–ç±åœ°', æ–¹è¨€: 'æ–¹è¨€',
        è¿ç§»æ—¶é—´: 'è¿ç§»', å·²çŸ¥äº²å±: 'äº²å±', ç±è´¯æ¨æ–­: 'ç±è´¯æ¨æ–­', ç½®ä¿¡åº¦: 'ç½®ä¿¡åº¦'
      };
      infoPanel.innerHTML = Object.entries(familyInfo).map(([k, v]) => `
        <div class="info-row">
          <span class="info-label">${labels[k] || k}</span>
          <span class="info-value">${v}</span>
        </div>
      `).join('');
    }

    // Update todo panel
    const todoPanel = document.getElementById('todoPanel');
    if (todos.length > 0) {
      todoPanel.innerHTML = `<div class="todo-list">${todos.map((t, i) => `
        <div class="todo-item ${t.done ? 'done' : ''}" onclick="toggleTodo(${i})">
          <div class="todo-check">${t.done ? 'âœ“' : ''}</div>
          <span class="todo-text">${t.text}</span>
        </div>
      `).join('')}</div>`;

      // Show badge if panel closed
      if (!panelOpen) {
        const undone = todos.filter(t => !t.done).length;
        const badge = document.getElementById('todoBadge');
        badge.textContent = undone;
        badge.classList.toggle('visible', undone > 0);
      }
    }
  }

  function toggleTodo(i) {
    todos[i].done = !todos[i].done;
    updatePanel();
  }

  async function sendMessage() {
    const input = document.getElementById('input');
    const text = input.value.trim();
    if (!text || isLoading) return;

    input.value = '';
    input.style.height = 'auto';
    isLoading = true;
    document.getElementById('sendBtn').disabled = true;

    addMessage('user', text);
    showTyping(); // FIXED: show typing immediately

    try {
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, session_id: sessionId })
      });

      if (!response.ok) throw new Error(`è¯·æ±‚å¤±è´¥ (${response.status})`);

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let fullText = '';
      let agentDiv = null;
      let firstChunk = true;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value, { stream: true });
        const lines = chunk.split('\n');

        for (const line of lines) {
          if (line.startsWith('data:')) {
            try {
              const data = JSON.parse(line.slice(5).trim());
              const newText = (data.type === 'answer' && data.content?.answer) ? data.content.answer : '';

              if (newText) {
                if (firstChunk) {
                  hideTyping(); // FIXED: hide typing only when first real content arrives
                  firstChunk = false;
                }
                fullText += newText;
                if (!agentDiv) {
                  agentDiv = addMessage('agent', fullText);
                } else {
                  agentDiv.querySelector('.bubble').innerHTML = formatMarkdown(fullText);
                  scrollToBottom();
                }
              }
            } catch (e) { /* skip */ }
          }
        }
      }

      hideTyping();

      if (!fullText) {
        addMessage('agent', 'æˆ‘æ”¶åˆ°äº†ä½ çš„ä¿¡æ¯ï¼Œæ­£åœ¨æ•´ç†æ€è·¯â€¦â€¦è¯·ç¨ç­‰ç‰‡åˆ»ã€‚');
      } else {
        parseAgentResponse(fullText);
      }

    } catch (err) {
      hideTyping();
      showError('è¿æ¥å‡ºç°é—®é¢˜ï¼š' + err.message);
    } finally {
      isLoading = false;
      document.getElementById('sendBtn').disabled = false;
      input.focus();
    }
  }
</script>
</body>
</html>
