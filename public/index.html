<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¯»æ ¹ Â· å½’å¤„</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600&family=Noto+Sans+SC:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root{--ink:#1a1208;--paper:#f5efe3;--warm:#c8956c;--gold:#b8860b;--red:#8b2020;--shadow:rgba(26,18,8,0.12);}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--paper);color:var(--ink);font-family:'Noto Sans SC',sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
  body::before{content:'';position:fixed;inset:0;background-image:radial-gradient(ellipse at 20% 50%,rgba(200,149,108,.08) 0%,transparent 60%),radial-gradient(ellipse at 80% 20%,rgba(139,32,32,.05) 0%,transparent 50%);pointer-events:none;z-index:0;}
  body::after{content:'';position:fixed;left:0;top:0;bottom:0;width:4px;background:linear-gradient(to bottom,transparent,var(--red),var(--gold),var(--red),transparent);opacity:.4;z-index:100;}

  header{flex-shrink:0;position:relative;z-index:50;padding:1rem 2rem;border-bottom:1px solid rgba(184,134,11,.2);display:flex;align-items:center;gap:1.5rem;background:rgba(245,239,227,.97);backdrop-filter:blur(8px);}
  .logo{font-family:'Noto Serif SC',serif;font-size:1.5rem;font-weight:600;color:var(--red);letter-spacing:.1em;}
  .logo-sub{font-size:.78rem;color:var(--gold);letter-spacing:.2em;font-weight:300;}
  .header-right{margin-left:auto;display:flex;align-items:center;gap:1rem;}
  .panel-toggle{background:rgba(200,149,108,.1);border:1px solid rgba(200,149,108,.3);border-radius:4px;padding:.4rem .9rem;font-size:.78rem;color:var(--ink);cursor:pointer;font-family:'Noto Sans SC',sans-serif;transition:all .2s;display:flex;align-items:center;gap:.5rem;white-space:nowrap;}
  .panel-toggle:hover{background:rgba(200,149,108,.2);}
  .badge{background:var(--red);color:white;border-radius:10px;padding:1px 6px;font-size:.65rem;display:none;line-height:1.4;}
  .badge.visible{display:inline;}
  .status-dot{display:flex;align-items:center;gap:.4rem;font-size:.72rem;color:var(--warm);}
  .dot{width:6px;height:6px;border-radius:50%;background:#5a8a5a;animation:pulse 2s infinite;}
  @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}

  .app-body{flex:1;display:flex;overflow:hidden;position:relative;z-index:1;}
  .chat-area{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:0 2rem;max-width:800px;margin:0 auto;width:100%;}

  /* SIDE PANEL */
  .side-panel{width:0;overflow:hidden;transition:width .3s ease;border-left:1px solid rgba(184,134,11,.15);background:rgba(255,255,255,.7);backdrop-filter:blur(4px);flex-shrink:0;display:flex;flex-direction:column;}
  .side-panel.open{width:300px;}
  .side-panel-inner{width:300px;overflow-y:auto;padding:1.2rem;display:flex;flex-direction:column;gap:1rem;flex:1;}
  .panel-section{background:white;border:1px solid rgba(184,134,11,.15);border-radius:6px;overflow:hidden;}
  .panel-section-header{padding:.6rem .9rem;background:rgba(200,149,108,.08);border-bottom:1px solid rgba(184,134,11,.1);font-family:'Noto Serif SC',serif;font-size:.8rem;color:var(--red);font-weight:600;letter-spacing:.05em;}
  .panel-section-body{padding:.8rem .9rem;font-size:.78rem;line-height:1.7;}
  .info-row{display:flex;gap:.5rem;margin-bottom:.35rem;align-items:flex-start;}
  .info-label{color:var(--gold);min-width:60px;flex-shrink:0;font-size:.72rem;margin-top:1px;}
  .todo-list{display:flex;flex-direction:column;gap:.4rem;}
  .todo-item{display:flex;align-items:flex-start;gap:.5rem;padding:.45rem .6rem;border-radius:4px;border:1px solid rgba(184,134,11,.12);cursor:pointer;transition:all .15s;font-size:.75rem;line-height:1.5;}
  .todo-item:hover{background:rgba(200,149,108,.06);}
  .todo-item.done{opacity:.45;}
  .todo-item.done .todo-text{text-decoration:line-through;}
  .todo-check{width:14px;height:14px;border:1.5px solid rgba(184,134,11,.4);border-radius:3px;flex-shrink:0;margin-top:1px;display:flex;align-items:center;justify-content:center;font-size:9px;color:white;transition:all .15s;}
  .todo-item.done .todo-check{background:var(--gold);border-color:var(--gold);}
  .empty-panel{text-align:center;padding:1.5rem .5rem;color:rgba(26,18,8,.3);font-size:.75rem;line-height:1.8;}

  /* WELCOME */
  .welcome{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:2rem;animation:fadeIn .8s ease;}
  .welcome-character{font-family:'Noto Serif SC',serif;font-size:4rem;color:var(--red);opacity:.12;line-height:1;margin-bottom:1.2rem;}
  .welcome h1{font-family:'Noto Serif SC',serif;font-size:1.4rem;font-weight:400;margin-bottom:.6rem;}
  .welcome p{font-size:.85rem;color:var(--warm);line-height:1.8;max-width:380px;margin:0 auto;font-weight:300;}
  .welcome-prompts{margin-top:1.8rem;display:flex;flex-direction:column;gap:.5rem;align-items:center;}
  .prompt-chip{background:rgba(200,149,108,.1);border:1px solid rgba(200,149,108,.25);border-radius:2px;padding:.5rem 1rem;font-size:.78rem;color:var(--ink);cursor:pointer;transition:all .2s;max-width:360px;text-align:center;}
  .prompt-chip:hover{background:rgba(200,149,108,.18);transform:translateX(3px);}

  /* MESSAGES */
  .messages{flex:1;overflow-y:auto;padding:1.2rem 0;display:none;flex-direction:column;gap:1rem;}
  .messages.visible{display:flex;}
  .message{display:flex;gap:.8rem;animation:slideIn .25s ease;}
  @keyframes slideIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
  .message.user{flex-direction:row-reverse;}
  .avatar{width:30px;height:30px;border-radius:2px;display:flex;align-items:center;justify-content:center;font-family:'Noto Serif SC',serif;font-size:.75rem;flex-shrink:0;margin-top:2px;}
  .avatar.agent{background:var(--red);color:var(--paper);}
  .avatar.user{background:var(--ink);color:var(--paper);opacity:.7;}
  .bubble{max-width:78%;padding:.85rem 1rem;line-height:1.8;font-size:.86rem;font-weight:300;}
  .message.agent .bubble{background:white;border:1px solid rgba(184,134,11,.15);border-radius:0 8px 8px 8px;box-shadow:0 2px 10px var(--shadow);}
  .message.user .bubble{background:var(--ink);color:var(--paper);border-radius:8px 0 8px 8px;opacity:.85;}

  /* STRUCTURED AGENT RESPONSE */
  .agent-response{display:flex;flex-direction:column;gap:.6rem;}
  .agent-message-text{line-height:1.8;font-size:.86rem;}

  .collapse-block{border:1px solid rgba(184,134,11,.15);border-radius:6px;overflow:hidden;}
  .collapse-header{padding:.55rem .8rem;background:rgba(200,149,108,.07);cursor:pointer;display:flex;align-items:center;justify-content:space-between;font-size:.82rem;font-weight:400;color:var(--ink);user-select:none;transition:background .15s;}
  .collapse-header:hover{background:rgba(200,149,108,.12);}
  .collapse-title{display:flex;align-items:center;gap:.4rem;}
  .collapse-arrow{font-size:.65rem;color:var(--warm);transition:transform .2s;margin-left:.5rem;}
  .collapse-header.open .collapse-arrow{transform:rotate(180deg);}
  .collapse-body{padding:.7rem .9rem;font-size:.82rem;line-height:1.8;display:none;border-top:1px solid rgba(184,134,11,.1);}
  .collapse-body.open{display:block;}

  /* Info grid inside collapse */
  .info-grid{display:flex;flex-direction:column;gap:.3rem;}
  .info-grid-row{display:flex;gap:.5rem;}
  .info-grid-label{color:var(--gold);min-width:55px;font-size:.75rem;flex-shrink:0;}
  .info-grid-value{color:var(--ink);font-size:.8rem;}

  /* Guide cards */
  .guide-card{border:1px solid rgba(184,134,11,.12);border-radius:5px;padding:.6rem .8rem;margin-bottom:.5rem;}
  .guide-card:last-child{margin-bottom:0;}
  .guide-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.3rem;}
  .guide-name{font-weight:600;font-size:.84rem;color:var(--ink);}
  .guide-score{background:var(--red);color:white;border-radius:10px;padding:1px 7px;font-size:.7rem;}
  .guide-location{font-size:.75rem;color:var(--warm);margin-bottom:.3rem;}
  .guide-reason{font-size:.75rem;color:rgba(26,18,8,.6);margin-bottom:.3rem;}
  .guide-contact{font-size:.72rem;color:var(--gold);}
  .guide-cases{margin-top:.3rem;padding-top:.3rem;border-top:1px solid rgba(184,134,11,.1);font-size:.72rem;color:rgba(26,18,8,.5);}

  /* Analysis text */
  .analysis-text{font-size:.82rem;line-height:1.8;color:var(--ink);}

  /* TYPING */
  .typing{display:none;gap:.8rem;align-items:flex-start;padding:.5rem 0;}
  .typing.visible{display:flex;}
  .typing-dots{background:white;border:1px solid rgba(184,134,11,.15);border-radius:0 8px 8px 8px;padding:.8rem 1.1rem;display:flex;gap:4px;align-items:center;box-shadow:0 2px 10px var(--shadow);}
  .typing-dots span{width:5px;height:5px;border-radius:50%;background:var(--warm);animation:bounce 1.2s infinite;}
  .typing-dots span:nth-child(2){animation-delay:.2s;}
  .typing-dots span:nth-child(3){animation-delay:.4s;}
  @keyframes bounce{0%,60%,100%{transform:translateY(0);opacity:.4;}30%{transform:translateY(-5px);opacity:1;}}

  /* INPUT */
  .input-area{flex-shrink:0;padding:.8rem 0 1.2rem;background:linear-gradient(to top,var(--paper) 85%,transparent);}
  .input-wrap{display:flex;border:1px solid rgba(184,134,11,.3);border-radius:3px;background:white;box-shadow:0 3px 16px var(--shadow);overflow:hidden;transition:border-color .2s;}
  .input-wrap:focus-within{border-color:var(--warm);}
  textarea{flex:1;border:none;outline:none;padding:.85rem 1rem;font-family:'Noto Sans SC',sans-serif;font-size:.86rem;font-weight:300;color:var(--ink);background:transparent;resize:none;min-height:46px;max-height:130px;line-height:1.6;}
  textarea::placeholder{color:rgba(26,18,8,.3);}
  .send-btn{background:none;border:none;border-left:1px solid rgba(184,134,11,.2);padding:0 1rem;cursor:pointer;color:var(--warm);transition:all .2s;font-size:1rem;display:flex;align-items:center;}
  .send-btn:hover{background:rgba(200,149,108,.1);color:var(--red);}
  .send-btn:disabled{opacity:.3;cursor:not-allowed;}
  .hint{text-align:center;font-size:.68rem;color:rgba(26,18,8,.25);margin-top:.4rem;}
  .error-msg{background:rgba(139,32,32,.06);border:1px solid rgba(139,32,32,.2);border-radius:4px;padding:.5rem .9rem;font-size:.78rem;color:var(--red);text-align:center;display:none;margin-bottom:.4rem;}
  .error-msg.visible{display:block;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
  .messages::-webkit-scrollbar,.side-panel-inner::-webkit-scrollbar{width:3px;}
  .messages::-webkit-scrollbar-thumb,.side-panel-inner::-webkit-scrollbar-thumb{background:rgba(200,149,108,.25);border-radius:2px;}
</style>
</head>
<body>
<header>
  <div class="logo">å¯»æ ¹</div>
  <div class="logo-sub">å½’å¤„ Â· æµ·å¤–åäººå¯»æ ¹å‘å¯¼</div>
  <div class="header-right">
    <button class="panel-toggle" onclick="togglePanel()" id="panelBtn">
      ğŸ“‹ å¯»æ ¹æ¡£æ¡ˆ <span class="badge" id="todoBadge"></span>
    </button>
    <div class="status-dot"><span class="dot"></span>å‘å¯¼åœ¨çº¿</div>
  </div>
</header>

<div class="app-body">
  <div class="chat-area">
    <div class="welcome" id="welcome">
      <div class="welcome-character">æ ¹</div>
      <h1>æ ‘æœ‰æ ¹ï¼Œäººä¸èƒ½å¿˜æœ¬</h1>
      <p>å‘Šè¯‰æˆ‘ä½ æ‰€çŸ¥é“çš„ä¸€åˆ‡â€”â€”å“ªæ€•åªæ˜¯ä¸€ä¸ªæ¨¡ç³Šçš„åœ°åï¼Œæˆ–æ˜¯è€äººç•™ä¸‹çš„åªè¨€ç‰‡è¯­ã€‚</p>
      <div class="welcome-prompts">
        <div class="prompt-chip" onclick="usePrompt(this)">æˆ‘æ˜¯é©¬æ¥è¥¿äºšåäººï¼ŒåªçŸ¥é“ç¥–ç±æ˜¯ç¦å»ºï¼Œæƒ³æ‰¾åˆ°æ›´å…·ä½“çš„åœ°æ–¹</div>
        <div class="prompt-chip" onclick="usePrompt(this)">çˆ·çˆ·è¯´æˆ‘ä»¬æ˜¯å¹¿ä¸œäººï¼Œå®¶é‡Œè¯´å®¢å®¶è¯ï¼Œæƒ³å¸®ä»–å®Œæˆå›ä¹¡çš„å¿ƒæ„¿</div>
        <div class="prompt-chip" onclick="usePrompt(this)">æˆ‘æœ‰ä¸€å¼ è€ç…§ç‰‡å’Œä¸€ä¸ªç¥–å…ˆçš„åå­—ï¼Œä¸çŸ¥é“ä»å“ªé‡Œå¼€å§‹å¯»æ ¹</div>
      </div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="typing" id="typing">
      <div class="avatar agent">å‘</div>
      <div class="typing-dots"><span></span><span></span><span></span></div>
    </div>
    <div class="input-area">
      <div class="error-msg" id="error"></div>
      <div class="input-wrap">
        <textarea id="input" placeholder="å‘Šè¯‰æˆ‘ä½ çŸ¥é“çš„å…³äºå®¶æ—çš„ä»»ä½•ä¿¡æ¯â€¦â€¦" rows="1"
          onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">â†‘</button>
      </div>
      <div class="hint">Enter å‘é€ Â· Shift+Enter æ¢è¡Œ</div>
    </div>
  </div>

  <div class="side-panel" id="sidePanel">
    <div class="side-panel-inner">
      <div class="panel-section">
        <div class="panel-section-header">ğŸ“‹ å·²æ”¶é›†çš„å®¶æ—ä¿¡æ¯</div>
        <div class="panel-section-body" id="infoPanel">
          <div class="empty-panel">å¼€å§‹å¯¹è¯åï¼Œ<br>ä¿¡æ¯ä¼šè‡ªåŠ¨æ•´ç†åœ¨è¿™é‡Œ</div>
        </div>
      </div>
      <div class="panel-section">
        <div class="panel-section-header">âœ… ä¸‹ä¸€æ­¥è¡ŒåŠ¨</div>
        <div class="panel-section-body" id="todoPanel">
          <div class="empty-panel">Agentä¼šä¸ºä½ <br>ç”Ÿæˆå¯å‹¾é€‰çš„è¡ŒåŠ¨æ¸…å•</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const API_URL = '/api/chat';
  let sessionId = 'sess_' + Math.random().toString(36).substr(2,16);
  let isLoading = false, conversationStarted = false, panelOpen = false;
  let todos = [], familyInfo = {};

  function togglePanel() {
    panelOpen = !panelOpen;
    document.getElementById('sidePanel').classList.toggle('open', panelOpen);
    document.getElementById('panelBtn').innerHTML = panelOpen
      ? 'âœ• å…³é—­æ¡£æ¡ˆ'
      : 'ğŸ“‹ å¯»æ ¹æ¡£æ¡ˆ <span class="badge" id="todoBadge"></span>';
    updateBadge();
  }

  function updateBadge() {
    const badge = document.getElementById('todoBadge');
    if (!badge) return;
    const undone = todos.filter(t => !t.done).length;
    badge.textContent = undone;
    badge.classList.toggle('visible', !panelOpen && undone > 0);
  }

  function usePrompt(el) { document.getElementById('input').value = el.textContent; sendMessage(); }
  function handleKey(e) { if (e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();} }
  function autoResize(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,130)+'px'; }
  function showError(msg) {
    const el = document.getElementById('error');
    el.textContent=msg; el.classList.add('visible');
    setTimeout(()=>el.classList.remove('visible'),5000);
  }

  function toggleCollapse(header) {
    header.classList.toggle('open');
    header.nextElementSibling.classList.toggle('open');
  }

  // Try to parse JSON from agent text
  function tryParseJSON(text) {
    try {
      // Find JSON object in the text
      const start = text.indexOf('{');
      const end = text.lastIndexOf('}');
      if (start === -1 || end === -1) return null;
      return JSON.parse(text.slice(start, end+1));
    } catch(e) {
      return null;
    }
  }

  // Render structured JSON response
  function renderStructuredResponse(data) {
    const parts = [];

    // Conversation message
    if (data.message) {
      parts.push(`<div class="agent-message-text">${data.message.replace(/\n/g,'<br>')}</div>`);
    }

    // User info summary - collapsible, default closed
    if (data.user_info) {
      const info = data.user_info;
      const rows = [
        ['å§“æ°', info.surname],
        ['ç¥–ç±', info.location],
        ['æ–¹è¨€', info.dialect],
        ['è¿ç§»', info.migration_info],
      ].filter(([,v]) => v && v !== 'æœªæä¾›' && v !== 'æœªçŸ¥');

      if (rows.length) {
        parts.push(`
          <div class="collapse-block">
            <div class="collapse-header" onclick="toggleCollapse(this)">
              <span class="collapse-title">ğŸ“‹ å·²æ”¶é›†ä¿¡æ¯</span>
              <span class="collapse-arrow">â–¼</span>
            </div>
            <div class="collapse-body">
              <div class="info-grid">
                ${rows.map(([l,v])=>`<div class="info-grid-row"><span class="info-grid-label">${l}</span><span class="info-grid-value">${v}</span></div>`).join('')}
              </div>
            </div>
          </div>`);

        // Update side panel
        rows.forEach(([l,v]) => { familyInfo[l] = v; });
        updateInfoPanel();
      }
    }

    // Analysis - collapsible, default open
    if (data.analysis) {
      parts.push(`
        <div class="collapse-block">
          <div class="collapse-header open" onclick="toggleCollapse(this)">
            <span class="collapse-title">ğŸ¯ äº²ç¼˜åœ°åˆ†æ</span>
            <span class="collapse-arrow">â–¼</span>
          </div>
          <div class="collapse-body open">
            <div class="analysis-text">${data.analysis.replace(/\n/g,'<br>')}</div>
          </div>
        </div>`);
    }

    // Intermediaries - collapsible, default open
    if (data.intermediaries && data.intermediaries.length > 0) {
      const guideCards = data.intermediaries.map(g => `
        <div class="guide-card">
          <div class="guide-header">
            <span class="guide-name">${g.name}</span>
            <span class="guide-score">${g.match_score}åˆ†</span>
          </div>
          <div class="guide-location">ğŸ“ ${g.location}</div>
          ${g.notes ? `<div class="guide-reason">${g.notes}</div>` : ''}
          ${g.contact_info ? `<div class="guide-contact">âœ‰ï¸ ${g.contact_info}</div>` : ''}
          ${g.success_cases && g.success_cases.length ? `
            <div class="guide-cases">
              ${g.success_cases.map(c=>`âœ“ ${c.description}ï¼ˆ${c.year}ï¼‰`).join('<br>')}
            </div>` : ''}
        </div>`).join('');

      parts.push(`
        <div class="collapse-block">
          <div class="collapse-header open" onclick="toggleCollapse(this)">
            <span class="collapse-title">ğŸ‘¥ æ¨èå‘å¯¼ï¼ˆ${data.intermediaries.length}ä½ï¼‰</span>
            <span class="collapse-arrow">â–¼</span>
          </div>
          <div class="collapse-body open">${guideCards}</div>
        </div>`);
    }

    // Todos
    if (data.todos && data.todos.length > 0) {
      data.todos.forEach(t => {
        if (!todos.find(x => x.text === t)) todos.push({text: t, done: false});
      });
      updateTodoPanel();
      updateBadge();
    }

    return `<div class="agent-response">${parts.join('')}</div>`;
  }

  // Render plain text (fallback)
  function renderPlainText(text) {
    return text
      .replace(/### (.+)/g,'<h4 style="font-family:Noto Serif SC;color:var(--red);margin:.6em 0 .2em;font-size:.88rem;">$1</h4>')
      .replace(/## (.+)/g,'<h3 style="font-family:Noto Serif SC;color:var(--red);margin:.8em 0 .3em;">$1</h3>')
      .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
      .replace(/\n/g,'<br>');
  }

  function updateInfoPanel() {
    const infoPanel = document.getElementById('infoPanel');
    if (Object.keys(familyInfo).length > 0) {
      infoPanel.innerHTML = Object.entries(familyInfo).map(([k,v])=>`
        <div class="info-row">
          <span class="info-label">${k}</span>
          <span>${v}</span>
        </div>`).join('');
    }
  }

  function updateTodoPanel() {
    const todoPanel = document.getElementById('todoPanel');
    if (todos.length > 0) {
      todoPanel.innerHTML = `<div class="todo-list">${todos.map((t,i)=>`
        <div class="todo-item ${t.done?'done':''}" onclick="toggleTodo(${i})">
          <div class="todo-check">${t.done?'âœ“':''}</div>
          <span class="todo-text">${t.text}</span>
        </div>`).join('')}</div>`;
    }
  }

  function toggleTodo(i) { todos[i].done=!todos[i].done; updateTodoPanel(); updateBadge(); }

  function addMessage(role, content, isHTML=false) {
    if (!conversationStarted) {
      document.getElementById('welcome').style.display='none';
      document.getElementById('messages').classList.add('visible');
      conversationStarted=true;
    }
    const messages = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = `message ${role}`;
    const bubbleContent = isHTML ? content : renderPlainText(content);
    div.innerHTML = `<div class="avatar ${role}">${role==='agent'?'å‘':'æˆ‘'}</div><div class="bubble">${bubbleContent}</div>`;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
    return div;
  }

  function showTyping() { document.getElementById('typing').classList.add('visible'); scrollDown(); }
  function hideTyping() { document.getElementById('typing').classList.remove('visible'); }
  function scrollDown() { const m=document.getElementById('messages'); m.scrollTop=m.scrollHeight; }

  async function sendMessage() {
    const input = document.getElementById('input');
    const text = input.value.trim();
    if (!text || isLoading) return;
    input.value=''; input.style.height='auto';
    isLoading=true; document.getElementById('sendBtn').disabled=true;
    addMessage('user', text);
    showTyping();

    try {
      const response = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({text, session_id:sessionId})
      });
      if (!response.ok) throw new Error(`è¯·æ±‚å¤±è´¥ (${response.status})`);

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let fullText='', agentDiv=null, firstChunk=true;

      while (true) {
        const {done, value} = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value,{stream:true});
        for (const line of chunk.split('\n')) {
          if (line.startsWith('data:')) {
            try {
              const data = JSON.parse(line.slice(5).trim());
              const newText = (data.type==='answer'&&data.content?.answer) ? data.content.answer : '';
              if (newText) {
                if (firstChunk) { hideTyping(); firstChunk=false; }
                fullText += newText;
                // Show streaming text as plain while loading
                if (!agentDiv) { agentDiv=addMessage('agent', fullText); }
                else { agentDiv.querySelector('.bubble').innerHTML=renderPlainText(fullText); scrollDown(); }
              }
            } catch(e){}
          }
        }
      }

      hideTyping();

      if (!fullText) {
        addMessage('agent','æˆ‘æ”¶åˆ°äº†ä½ çš„ä¿¡æ¯ï¼Œæ­£åœ¨æ•´ç†ä¸­â€¦â€¦');
      } else {
        // Try to parse as JSON and re-render structured
        const parsed = tryParseJSON(fullText);
        console.log('parsed result:', parsed);
        if (parsed && agentDiv) {
          agentDiv.querySelector('.bubble').innerHTML = renderStructuredResponse(parsed);
          scrollDown();
        }
        // If no JSON found, plain text stays as-is
      }

    } catch(err) {
      hideTyping();
      showError('è¿æ¥å‡ºç°é—®é¢˜ï¼š'+err.message);
    } finally {
      isLoading=false;
      document.getElementById('sendBtn').disabled=false;
      input.focus();
    }
  }
</script>
</body>
</html>
